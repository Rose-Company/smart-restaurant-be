# Use the latest 2.1 version of CircleCI pipeline process engine.
version: 2.1

orbs:
  docker: circleci/docker@2.1.4

executors:
  docker-executor:
    docker:
      - image: cimg/base:stable
    resource_class: large

jobs:
  test:
    docker:
      - image: golang:1.21
    steps:
      - checkout
      - run:
          name: Download dependencies
          command: go mod download
      - run:
          name: Run Tests
          command: go test ./... -v

  build:
    executor: docker-executor
    steps:
      - checkout
      - setup_remote_docker:
          version: docker24
      - run:
          name: Build Docker Image
          command: |
            docker build -t rosecompany/smart-restaurant-api:${CIRCLE_SHA1:0:7} .
            docker tag rosecompany/smart-restaurant-api:${CIRCLE_SHA1:0:7} rosecompany/smart-restaurant-api:latest
      - run:
          name: Save Docker Image
          command: |
            mkdir -p /tmp/workspace
            docker save rosecompany/smart-restaurant-api:${CIRCLE_SHA1:0:7} > /tmp/workspace/docker-image.tar
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - docker-image.tar

  push-to-registry:
    executor: docker-executor
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - setup_remote_docker:
          version: docker24
      - run:
          name: Load Docker Image
          command: |
            docker load < /tmp/workspace/docker-image.tar
      - run:
          name: Docker Login
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Push to Docker Registry
          command: |
            docker push rosecompany/smart-restaurant-api:${CIRCLE_SHA1:0:7}
            docker push rosecompany/smart-restaurant-api:latest

  deploy-to-staging:
    executor: docker-executor
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "$SSH_KEY_FINGERPRINT"
      - run:
          name: Deploy Staging to Shared Server
          command: |
            export DEPLOY_VERSION=${CIRCLE_SHA1:0:7}
            cat > /tmp/deploy-staging.sh \<< 'EOFSH'
            #!/bin/bash
            set -e
            cd /app/smart-restaurant-api-staging
            git fetch origin
            git checkout staging
            git pull origin staging
            docker pull rosecompany/smart-restaurant-api:$DEPLOY_VERSION
            docker compose -f docker-compose.staging.yaml down || true
            sed -i "s|rosecompany/smart-restaurant-api:.*|rosecompany/smart-restaurant-api:$DEPLOY_VERSION|g" docker-compose.staging.yaml
            docker compose -f docker-compose.staging.yaml up -d
            sleep 5
            curl -f http://localhost:8080/health/status || exit 1
            echo "✅ Staging deployment successful!"
            EOFSH
            chmod +x /tmp/deploy-staging.sh
            scp -o StrictHostKeyChecking=no -P "$SSH_PORT" /tmp/deploy-staging.sh "$SSH_USER@$SSH_HOST:/tmp/"
            ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "DEPLOY_VERSION=$DEPLOY_VERSION bash /tmp/deploy-staging.sh"

  deploy-to-production:
    executor: docker-executor
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "$SSH_KEY_FINGERPRINT"
      - run:
          name: Deploy Production to Shared Server
          command: |
            export DEPLOY_VERSION=${CIRCLE_SHA1:0:7}
            cat > /tmp/deploy-production.sh \<< 'EOFSH'
            #!/bin/bash
            set -e
            cd /app/smart-restaurant-api-production
            git fetch origin
            git checkout main
            git pull origin main
            docker pull rosecompany/smart-restaurant-api:$DEPLOY_VERSION
            docker compose down || true
            sed -i "s|rosecompany/smart-restaurant-api:.*|rosecompany/smart-restaurant-api:$DEPLOY_VERSION|g" docker-compose.yaml
            docker compose up -d
            sleep 5
            curl -f http://localhost:3000/health/status || exit 1
            echo "✅ Production deployment successful!"
            EOFSH
            chmod +x /tmp/deploy-production.sh
            scp -o StrictHostKeyChecking=no -P "$SSH_PORT" /tmp/deploy-production.sh "$SSH_USER@$SSH_HOST:/tmp/"
            ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "DEPLOY_VERSION=$DEPLOY_VERSION bash /tmp/deploy-production.sh"

workflows:
  build-test-deploy:
    jobs:
      - test:
          filters:
            branches:
              only:
                - main
                - staging
      
      - build:
          requires:
            - test
          filters:
            branches:
              only:
                - main
                - staging
      
      - push-to-registry:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - staging
      
      - deploy-to-staging:
          requires:
            - push-to-registry
          filters:
            branches:
              only:
                - staging
      
      - approve-production-deployment:
          type: approval
          requires:
            - push-to-registry
          filters:
            branches:
              only:
                - main
      
      - deploy-to-production:
          requires:
            - approve-production-deployment
          filters:
            branches:
              only:
                - main